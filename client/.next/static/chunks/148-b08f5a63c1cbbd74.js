"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[148],{8554:function(t,e,r){r.d(e,{Z:function(){return i},j:function(){return c}});var o=r(7437),a=r(2265),s=r(164);let n=(0,a.createContext)(void 0),c=()=>{let t=(0,a.useContext)(n);if(!t)throw Error("useCart must be used within a CartProvider");return t},i=t=>{let{children:e}=t,[r,c]=(0,a.useState)([]),[i,d]=(0,a.useState)(!0),[l,u]=(0,a.useState)(null),[g,y]=(0,a.useState)(!1);(0,a.useEffect)(()=>{let t=async()=>{try{let t=await s.h.auth.getProfile().catch(()=>null);y(!!t)}catch(t){y(!1)}};t()},[]),(0,a.useEffect)(()=>{let t=async()=>{try{if(d(!0),g){let t=await s.h.cart.get();c(t.items.map(h))}else{let t=localStorage.getItem("cart");if(t){let e=JSON.parse(t);c(e)}}u(null)}catch(t){if(g)u("Не удалось загрузить корзину"),console.error("Error loading cart:",t);else{let e=localStorage.getItem("cart");if(e){let t=JSON.parse(e);c(t),u(null)}else u("Не удалось загрузить корзину"),console.error("Error loading cart:",t)}}finally{d(!1)}};t()},[g]);let h=t=>({...t,_id:t.product._id}),f=t=>{localStorage.setItem("cart",JSON.stringify(t))},m=async()=>{try{if(d(!0),g){let t=await s.h.cart.get();c(t.items.map(h))}else{let t=localStorage.getItem("cart");if(t){let e=JSON.parse(t);c(e)}}u(null)}catch(t){u("Ошибка синхронизации корзины"),console.error("Cart sync error:",t)}finally{d(!1)}},p=async function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,o=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0;try{if(console.log("addItem called with:",{productId:t._id,quantity:e,size:o,color:a}),console.log("Current items before adding:",r),g)await s.h.cart.add(t._id,e,o,a),await m();else{let s;let n={_id:t._id,product:{...t,category:t.category||(t.categoryId?{_id:t.categoryId._id,name:t.categoryId.name,slug:t.categoryId.slug,isActive:!0,sortOrder:1,level:1}:void 0)},quantity:e,size:o,color:a},i=r.findIndex(e=>e._id===t._id&&e.size===o&&e.color===a);console.log("Existing item index:",i),i>=0?(s=[...r],s[i].quantity+=e,console.log("Updated existing item quantity:",s[i].quantity)):(s=[...r,n],console.log("Added new item to cart")),console.log("Updated items after adding:",s),c(s),f(s)}}catch(t){u("Не удалось добавить товар в корзину"),console.error("Add to cart error:",t)}},v=async(t,e,o)=>{try{if(g)await s.h.cart.remove(t,e,o),await m();else{let a=r.filter(r=>!(r._id===t&&r.size===e&&r.color===o));c(a),f(a)}}catch(t){u("Не удалось удалить товар из корзины"),console.error("Remove from cart error:",t)}},w=async(t,e,o,a)=>{try{if(g)await s.h.cart.update(t,e,o,a),await m();else{let s=r.map(r=>r._id===t&&r.size===o&&r.color===a?{...r,quantity:e}:r);c(s),f(s)}}catch(t){u("Не удалось обновить количество товара"),console.error("Update quantity error:",t)}},S=async()=>{try{g?(await s.h.cart.clear(),await m()):(c([]),localStorage.removeItem("cart"))}catch(t){u("Не удалось очистить корзину"),console.error("Clear cart error:",t)}},A=r.length,P=r.reduce((t,e)=>t+e.quantity,0),b=r.reduce((t,e)=>t+e.product.price*e.quantity,0);return(0,o.jsx)(n.Provider,{value:{items:r,totalItems:A,totalQuantity:P,totalPrice:b,loading:i,error:l,addItem:p,removeItem:v,updateQuantity:w,clearCart:S,isInCart:(t,e,o)=>{console.log("isInCart called with:",{productId:t,size:e,color:o}),console.log("Current cart items:",r);let a=r.some(r=>r._id===t&&r.size===e&&r.color===o);return console.log("isInCart result:",a),a},getCartItem:(t,e,o)=>r.find(r=>r._id===t&&r.size===e&&r.color===o)},children:e})}},3023:function(t,e,r){r.d(e,{z:function(){return d}});var o=r(7437),a=r(2265),s=r(7256),n=r(9213),c=r(9311);let i=(0,n.j)("inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-all duration-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",{variants:{variant:{default:"bg-gradient-to-r from-primary-300 to-primary-500 text-primary-900 hover:from-primary-400 hover:to-primary-600 shadow-md hover:shadow-lg transform hover:-translate-y-0.5",destructive:"bg-gradient-to-r from-destructive to-destructive/90 text-destructive-foreground hover:from-destructive/90 hover:to-destructive shadow-md hover:shadow-lg transform hover:-translate-y-0.5",outline:"border-2 border-secondary-200 bg-white hover:border-primary-300 hover:text-primary-600 shadow-sm hover:shadow-md transform hover:-translate-y-0.5",secondary:"bg-gradient-to-r from-secondary-500 to-secondary-600 text-secondary-foreground hover:from-secondary-600 hover:to-secondary-700 shadow-md hover:shadow-lg transform hover:-translate-y-0.5",ghost:"hover:bg-primary-50 hover:text-primary-600 transform hover:-translate-y-0.5",link:"text-primary-600 underline-offset-4 hover:underline hover:text-primary-700",premium:"bg-gradient-to-r from-gold-400 to-gold-600 text-charcoal-900 hover:from-gold-500 hover:to-gold-700 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 border border-gold-300",accent:"bg-gradient-to-r from-accent-400 to-accent-500 text-white hover:from-accent-500 hover:to-accent-600 shadow-md hover:shadow-lg transform hover:-translate-y-0.5"},size:{default:"h-11 px-5 py-2.5 rounded-lg",sm:"h-9 rounded-md px-3 py-2 text-xs",lg:"h-12 rounded-lg px-8 py-3 text-base",xl:"h-14 rounded-xl px-10 py-4 text-lg",icon:"h-10 w-10 rounded-full"}},defaultVariants:{variant:"default",size:"default"}}),d=a.forwardRef((t,e)=>{let{className:r,variant:a,size:n,asChild:d=!1,...l}=t,u=d?s.g7:"button";return(0,o.jsx)(u,{className:(0,c.cn)(i({variant:a,size:n,className:r})),ref:e,...l})});d.displayName="Button"},7478:function(t,e,r){r.d(e,{L:function(){return i},z:function(){return d}});var o=r(7437),a=r(2265),s=r(164);let n=[{_id:"glasses",name:"Очки",slug:"glasses",isActive:!0,sortOrder:1,level:1,categoryType:"GLASSES"},{_id:"clothing",name:"Одежда",slug:"clothing",isActive:!0,sortOrder:2,level:1,categoryType:"CLOTHING"},{_id:"shoes",name:"Обувь",slug:"shoes",isActive:!0,sortOrder:3,level:1,categoryType:"SHOES"},{_id:"accessories",name:"Аксессуары",slug:"accessories",isActive:!0,sortOrder:4,level:1,categoryType:"ACCESSORIES"}],c=(0,a.createContext)({categories:n,isLoading:!1,error:null}),i=()=>(0,a.useContext)(c),d=t=>{let{children:e}=t,[r,i]=(0,a.useState)(n),[d,l]=(0,a.useState)(!1),[u,g]=(0,a.useState)(null);return(0,a.useEffect)(()=>{let t=async()=>{l(!0);try{let t=await s.h.categories.getAll(),e=t.filter(t=>t.isActive);e.length>0&&(i(e),localStorage.setItem("dvb_categories",JSON.stringify(e))),g(null)}catch(t){console.error("Failed to load categories:",t),g("Failed to load categories")}finally{l(!1)}};(()=>{try{let t=localStorage.getItem("dvb_categories");if(t){let e=JSON.parse(t);Array.isArray(e)&&e.length>0&&i(e)}}catch(t){console.error("Error loading cached categories:",t)}})(),t()},[]),(0,o.jsx)(c.Provider,{value:{categories:r,isLoading:d,error:u},children:e})}},164:function(t,e,r){r.d(e,{h:function(){return s}});let o="https://api.dvberry.ru/api";async function a(t,e){let r=0;for(console.log("API Request: ".concat(o).concat(t));r<=3;)try{let a=await fetch("".concat(o).concat(t),{...e,headers:{"Content-Type":"application/json",...null==e?void 0:e.headers},credentials:"include"});if(console.log("API Response status: ".concat(a.status," for ").concat(t)),429===a.status){if(++r>3)throw Error("Too many requests. Please try again later.");let t=1e3*Math.pow(2,r);await new Promise(e=>setTimeout(e,t));continue}if(!a.ok){let e;if(t.includes("/auth/")&&(401===a.status||404===a.status))throw await a.json().catch(()=>({})),console.log("Auth endpoint returned",a.status,"- user likely not authenticated"),Error("Not authenticated");try{e=await a.json()}catch(t){e={message:"HTTP error! status: ".concat(a.status)}}throw console.error("API Error:",e),Error(e.message||"API request failed")}let s=await a.json();return console.log("✅ API Response data for ".concat(t,":"),s),!t.includes("/products")||(null==s?void 0:s.success)||console.warn("⚠️ Products API response:",s),s}catch(e){if(console.error("API Request failed for ".concat(t,":"),e),e instanceof TypeError&&r<3){r++;let t=1e3*Math.pow(2,r);await new Promise(e=>setTimeout(e,t));continue}throw e}throw Error("Maximum retry attempts reached")}let s={products:{getAll:async t=>{let e=new URLSearchParams;t&&Object.entries(t).forEach(t=>{let[r,o]=t;void 0!==o&&e.append(r,o.toString())});let r=e.toString(),o="/products".concat(r?"?".concat(r):"");console.log("Fetching products from:",o);let s=await a(o);if(console.log("Products API response:",s),s&&!0===s.success&&s.data&&s.data.products&&Array.isArray(s.data.products)){var n,c,i,d;return console.log("✅ Using server format: success.data.products"),console.log("\uD83D\uDCE6 Products count:",s.data.products.length),console.log("\uD83D\uDCE6 First product name:",(null===(n=s.data.products[0])||void 0===n?void 0:n.name)||"none"),{data:s.data.products,summary:{total:(null===(c=s.data.pagination)||void 0===c?void 0:c.total)||s.data.products.length,page:(null===(i=s.data.pagination)||void 0===i?void 0:i.page)||1,pages:(null===(d=s.data.pagination)||void 0===d?void 0:d.pages)||1}}}return s&&s.products&&Array.isArray(s.products)?(console.log("Using direct products format"),{data:s.products,summary:s.pagination||{total:s.products.length,page:1,pages:1}}):Array.isArray(s)?(console.log("Using direct array format"),{data:s,summary:{total:s.length,page:1,pages:1}}):s&&s.data&&Array.isArray(s.data)?(console.log("Using direct data array format"),{data:s.data,summary:{total:s.data.length,page:1,pages:1}}):(console.error("Unexpected API response format:",s),{data:[],summary:{total:0,page:1,pages:1}})},getById:async t=>a("/products/".concat(t)),getBySlug:async t=>a("/products/".concat(t)),getByCategory:async t=>{let e=await a("/products?category=".concat(t));return(console.log("Products by category API response:",e),e&&!0===e.success&&e.data&&e.data.products&&Array.isArray(e.data.products))?(console.log("✅ Using server format: success.data.products"),e.data.products):(console.error("❌ Unexpected API response format:",e),[])},getPopular:async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:6;return a("/products?isFeatured=true&limit=".concat(t))},getNew:async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:6;return a("/products?isBrandNew=true&limit=".concat(t))},getOnSale:async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:6;return a("/products?isOnSale=true&limit=".concat(t))},search:async t=>{let e=await a("/products?search=".concat(encodeURIComponent(t)));return(console.log("Search API response:",e),e&&!0===e.success&&e.data&&e.data.products&&Array.isArray(e.data.products))?(console.log("✅ Using server format: success.data.products"),e.data.products):(console.error("❌ Unexpected API response format:",e),[])}},cart:{get:async()=>a("/cart"),add:async function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2?arguments[2]:void 0,o=arguments.length>3?arguments[3]:void 0;return a("/cart/add",{method:"POST",body:JSON.stringify({productId:t,quantity:e,size:r,color:o})})},update:async(t,e,r,o)=>a("/cart/".concat(t),{method:"PUT",body:JSON.stringify({quantity:e,size:r,color:o})}),remove:async(t,e,r)=>a("/cart/".concat(t),{method:"DELETE",body:JSON.stringify({size:e,color:r})}),clear:async()=>a("/cart",{method:"DELETE"})},favorites:{get:async()=>a("/favorites"),add:async t=>a("/favorites",{method:"POST",body:JSON.stringify({productId:t})}),remove:async t=>a("/favorites/".concat(t),{method:"DELETE"}),check:async t=>a("/favorites/check/".concat(t))},auth:{register:async(t,e,r,o)=>a("/auth/register",{method:"POST",body:JSON.stringify({firstName:t,lastName:e,email:r,password:o})}),login:async(t,e)=>a("/auth/login",{method:"POST",body:JSON.stringify({email:t,password:e})}),logout:async()=>a("/auth/logout",{method:"POST"}),getProfile:async()=>a("/auth/profile"),updateProfile:async(t,e,r)=>a("/auth/profile",{method:"PUT",body:JSON.stringify({firstName:t,lastName:e,email:r})}),changePassword:async(t,e)=>a("/auth/change-password",{method:"POST",body:JSON.stringify({currentPassword:t,newPassword:e})}),forgotPassword:async t=>a("/auth/forgot-password",{method:"POST",body:JSON.stringify({email:t})}),resetPassword:async(t,e)=>a("/auth/reset-password",{method:"POST",body:JSON.stringify({token:t,password:e})})},categories:{getAll:async()=>{let t=await a("/categories");return t.success&&t.data&&t.data.categories?t.data.categories:Array.isArray(t)?t:[]},getBySlug:async t=>{let e=await a("/categories/".concat(t));return e.success&&e.data&&e.data.category?e.data.category:e}},orders:{create:async(t,e)=>a("/orders",{method:"POST",body:JSON.stringify({items:t,shippingAddress:e})}),getUserOrders:async()=>a("/orders"),getOrderById:async t=>a("/orders/".concat(t))}}},9311:function(t,e,r){r.d(e,{cn:function(){return s}});var o=r(7042),a=r(4769);function s(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];return(0,a.m6)((0,o.W)(e))}}}]);